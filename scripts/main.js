!function(e){"use strict";var t=function(e){this.map=null,this.layers=[],this.extent=[[-115.85,-38.82],[119.25,52.58]],this.snippet="This is a new map",this.title="New Map",this.webmap={},this.defaultWebMap={},this.defaultWebMap.item={title:this.title,snippet:this.snippit,extent:this.extent},this.defaultWebMap.itemData={baseMap:{baseMapLayers:[{opacity:1,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer"},{opacity:.3,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}],title:"basemap"},version:"1.0"},this.getWebMap(),this._setDefaultRenderers(),this._initMap(),this._wire();new OpenSearch("search-container",{})};t.prototype.getWebMap=function(){var t=localStorage.getItem("webMapJson");console.log("LOAD JSON:",JSON.parse(t)),t?(this.webmap=JSON.parse(t),this._layersFromWebMapJson()):(this.webmap=this.defaultWebMap,console.log("this.webmap.extent",this.webmap.extent)),e.webmap=this.webmap},t.prototype._initMap=function(){var e=this;require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],function(t,i,a,r,s,o){e.FeatureLayer=r,e.SimpleRenderer=s,e.jsonUtils=o,a.createMap(e.webmap,"map",{mapOptions:{minZoom:2}}).then(function(t){e.map=t.map,e.map.on("extent-change",function(){e._updateExtent()})})})},t.prototype.addLayerToMap=function(t,i){var a,r=this;this.malette&&this.malette.destroy();var s=new this.FeatureLayer(t,{mode:this.FeatureLayer.MODE_ONDEMAND,outFields:["*"]});this.map.addLayer(s),this.layers.push({url:t,visibility:!0,opacity:.78,mode:1,title:s.name,id:s.id,layerDefinition:{drawingInfo:{renderer:{}}}}),s.on("load",function(){switch(s.minScale=0,s.maxScale=0,console.log("layer loaded!",s),s.geometryType){case"esriGeometryPoint":a="point";break;case"esriGeometryPolygon":a="polygon";break;default:a="point"}var o=r.isWebMercator(s.spatialReference);o?r.map.setExtent(s.fullExtent.expand(2),!1):r.projectGeometries(s.fullExtent.spatialReference.wkid,102100,"esriGeometryEnvelope",s.fullExtent).done(function(e){var t=e.geometries[0];t.spatialReference={wkid:102100};var i=new esri.geometry.Extent(t);r.map.setExtent(i.expand(2),!1)});var n=r.renderers[a],l=new r.SimpleRenderer(n);s.setRenderer(l),s.redraw(),r._updateLayers(t,l),$.getJSON("http://opendata.arcgis.com/datasets/"+i+".json",function(i){var o=i.data.fields,l=i.data.name;r.malette=new Malette("map",{title:l,style:n,formatIn:"esri-json",formatOut:"esri-json",fields:o,type:a,exportStyle:!0}),e.malette=r.malette,"polygon"===a?setTimeout(function(){$("#malette-theme-color-option").trigger("click")},100):"point"===a&&setTimeout(function(){$("#malette-size-tab").trigger("click"),$("#malette-graduated-size-option").trigger("click")},100),r.malette.on("style-change",function(e){console.log("exported style",e);var i=r.jsonUtils.fromJson(e);s.setRenderer(i),s.redraw(),r._updateLayers(t,i)})})})},t.prototype._layersFromWebMapJson=function(){var e=this;this.webmap.itemData.operationalLayers.forEach(function(t){var i={};i.url=t.url,i.visibility=t.visibility,i.opacity=t.opacity,i.layerDefinition=t.layerDefinition,i.mode=t.mode,i.id=t.id,e.layers.push(i)})},t.prototype._updateLayers=function(e,t){this.layers.forEach(function(i){i.url===e&&(i.layerDefinition.drawingInfo.renderer=t.toJson())})},t.prototype._updateExtent=function(){var e=this.map.geographicExtent;this.extent=[[e.xmin,e.ymin],[e.xmax,e.ymax]]},t.prototype.getBasemapLayers=function(){var e=[];return this.webmap.itemData.baseMap.baseMapLayers.forEach(function(t){var i={};i.opacity=t.opacity,i.visibility=t.visibility,i.url=t.url,e.push(i)}),e},t.prototype._buildWebMapJson=function(){var e={},t=this.getBasemapLayers();return e.item={title:this.title,snippet:this.snippet,extent:this.extent},e.itemData={operationalLayers:this.layers,baseMap:{baseMapLayers:t,title:"basemap"},version:"1.0"},console.log("web map json: ",e),e},t.prototype.save=function(){var e=this._buildWebMapJson();$("#save-text").html("Saving..."),console.log("saving...",e),localStorage.setItem("webMapJson",JSON.stringify(e)),setTimeout(function(){$("#save-text").html("Save")},300)},t.prototype.clearLayers=function(){var e=this;this.malette&&(this.malette.destroy(),this.malette=null),this.map.graphicsLayerIds.forEach(function(t){e.map.removeLayer(e.map.getLayer(t))}),this.layers=[],this.save()},t.prototype.isWebMercator=function(e){var t=[102100,102113,3857],i=!1;return t.forEach(function(t){(e.wkid===t||e.latestWkid===t)&&(i=!0)}),i},t.prototype.projectGeometries=function(e,t,i,a){var r="http://utilitydev.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer/project",s={geometryType:i,geometries:[a]},o={geometries:JSON.stringify(s),transformForward:!1,transformation:"",inSR:e,outSR:t,f:"json"},n={url:r,method:"POST",data:o,dataType:"json"};return $.ajax(n)},t.prototype._setDefaultRenderers=function(){this.renderers={point:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:1.3,type:"esriSLS",style:"esriSLSSolid"}}},polygon:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,style:"esriSFSSolid",type:"esriSFS",outline:{color:[255,255,255,255],width:.5,type:"esriSLS",style:"esriSLSSolid"}}}}},t.prototype._wire=function(){var e=this;console.log("wire me"),$("#clear-layers").on("click",function(){e.clearLayers()}),$("#add-data").on("click",function(){$("#search-container").toggle()}),$("#save-map").on("click",function(){e.save()}),$("#map").on("dragover",function(e){e.preventDefault()}),$("#map").on("drop",function(t){var i=t.originalEvent.dataTransfer.getData("text"),a=i.split(","),r=a[0],s=a[1];$("#search-container").hide(),e.addLayerToMap(r,s)})},e.App=t}(window);