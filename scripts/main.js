(function(){"use strict";var e,t;"undefined"!=typeof exports?(e=require("xmlhttprequest").XMLHttpRequest,"undefined"==typeof t&&(t=require("btoa"))):t=window.btoa,"undefined"!=typeof window&&"undefined"!=typeof window.XMLHttpRequest&&(e=window.XMLHttpRequest);var n=function(i){function s(n,s,o,a,u,l){function c(){var e=s.indexOf("//")>=0?s:r+s;return e+=/\?/.test(e)?"&":"?",o&&"object"==typeof o&&["GET","HEAD"].indexOf(n)>-1&&(e+="&"+Object.keys(o).map(function(e){return e+"="+o[e]}).join("&")),e+"&"+(new Date).getTime()}var p=new e;if(p.open(n,c(),!l),l||(p.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300||304===this.status?a(null,u?this.responseText:this.responseText?JSON.parse(this.responseText):!0,this):a({path:s,request:this,error:this.status}))}),u?p.setRequestHeader("Accept","application/vnd.github.v3.raw+json"):(p.dataType="json",p.setRequestHeader("Accept","application/vnd.github.v3+json")),p.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.token||i.username&&i.password){var h=i.token?"token "+i.token:"Basic "+t(i.username+":"+i.password);p.setRequestHeader("Authorization",h)}return o?p.send(JSON.stringify(o)):p.send(),l?p.response:void 0}function o(e,t){var n=[];!function i(){s("GET",e,null,function(s,o,r){if(s)return t(s);n.push.apply(n,o);var a=(r.getResponseHeader("link")||"").split(/\s*,\s*/g),u=null;a.forEach(function(e){u=/rel="next"/.test(e)?e:u}),u&&(u=(/<(.*)>/.exec(u)||[])[1]),u?(e=u,i()):t(s,n)})}()}var r=i.apiUrl||"https://api.github.com";n.User=function(){this.repos=function(e){o("/user/repos?type=all&per_page=1000&sort=updated",function(t,n){e(t,n)})},this.orgs=function(e){s("GET","/user/orgs",null,function(t,n){e(t,n)})},this.gists=function(e){s("GET","/gists",null,function(t,n){e(t,n)})},this.notifications=function(e){s("GET","/notifications",null,function(t,n){e(t,n)})},this.show=function(e,t){var n=e?"/users/"+e:"/user";s("GET",n,null,function(e,n){t(e,n)})},this.userRepos=function(e,t){o("/users/"+e+"/repos?type=all&per_page=1000&sort=updated",function(e,n){t(e,n)})},this.userGists=function(e,t){s("GET","/users/"+e+"/gists",null,function(e,n){t(e,n)})},this.orgRepos=function(e,t){o("/orgs/"+e+"/repos?type=all&&page_num=1000&sort=updated&direction=desc",function(e,n){t(e,n)})},this.follow=function(e,t){s("PUT","/user/following/"+e,null,function(e,n){t(e,n)})},this.unfollow=function(e,t){s("DELETE","/user/following/"+e,null,function(e,n){t(e,n)})},this.createRepo=function(e,t){s("POST","/user/repos",e,t)}},n.Repository=function(e){function i(e,t){return e===l.branch&&l.sha?t(null,l.sha):void a.getRef("heads/"+e,function(n,i){l.branch=e,l.sha=i,t(n,i)})}var o=e.name,r=e.user,a=this,u="/repos/"+r+"/"+o,l={branch:null,sha:null};this.deleteRepo=function(t){s("DELETE",u,e,t)},this.getRef=function(e,t){s("GET",u+"/git/refs/"+e,null,function(e,n){return e?t(e):void t(null,n.object.sha)})},this.createRef=function(e,t){s("POST",u+"/git/refs",e,t)},this.deleteRef=function(t,n){s("DELETE",u+"/git/refs/"+t,e,n)},this.createRepo=function(e,t){s("POST","/user/repos",e,t)},this.deleteRepo=function(t){s("DELETE",u,e,t)},this.listTags=function(e){s("GET",u+"/tags",null,function(t,n){return t?e(t):void e(null,n)})},this.listPulls=function(e,t){s("GET",u+"/pulls"+(e?"?state="+e:""),null,function(e,n){return e?t(e):void t(null,n)})},this.getPull=function(e,t){s("GET",u+"/pulls/"+e,null,function(e,n){return e?t(e):void t(null,n)})},this.compare=function(e,t,n){s("GET",u+"/compare/"+e+"..."+t,null,function(e,t){return e?n(e):void n(null,t)})},this.listBranches=function(e){s("GET",u+"/git/refs/heads",null,function(t,n){return t?e(t):void e(null,n.map(function(e){var t=e.ref.split("/");return t[t.length-1]}))})},this.getBlob=function(e,t){s("GET",u+"/git/blobs/"+e,null,t,"raw")},this.getCommit=function(e,t,n){s("GET",u+"/git/commits/"+t,null,function(e,t){return e?n(e):void n(null,t)})},this.getSha=function(e,t,n){return t&&""!==t?void s("GET",u+"/contents/"+t+(e?"?ref="+e:""),null,function(e,t){return e?n(e):void n(null,t.sha)}):a.getRef("heads/"+e,n)},this.getTree=function(e,t){s("GET",u+"/git/trees/"+e,null,function(e,n){return e?t(e):void t(null,n.tree)})},this.postBlob=function(e,n){e="string"==typeof e?{content:e,encoding:"utf-8"}:{content:t(String.fromCharCode.apply(null,new Uint8Array(e))),encoding:"base64"},s("POST",u+"/git/blobs",e,function(e,t){return e?n(e):void n(null,t.sha)})},this.updateTree=function(e,t,n,i){var o={base_tree:e,tree:[{path:t,mode:"100644",type:"blob",sha:n}]};s("POST",u+"/git/trees",o,function(e,t){return e?i(e):void i(null,t.sha)})},this.postTree=function(e,t){s("POST",u+"/git/trees",{tree:e},function(e,n){return e?t(e):void t(null,n.sha)})},this.commit=function(t,i,o,r){var a=new n.User;a.show(null,function(n,a){if(n)return r(n);var c={message:o,author:{name:e.user,email:a.email},parents:[t],tree:i};s("POST",u+"/git/commits",c,function(e,t){return e?r(e):(l.sha=t.sha,void r(null,t.sha))})})},this.updateHead=function(e,t,n){s("PATCH",u+"/git/refs/heads/"+e,{sha:t},function(e){n(e)})},this.show=function(e){s("GET",u,null,e)},this.contributors=function(e,t){t=t||1e3;var n=this;s("GET",u+"/stats/contributors",null,function(i,s,o){return i?e(i):void(202===o.status?setTimeout(function(){n.contributors(e,t)},t):e(i,s))})},this.contents=function(e,t,n){t=encodeURI(t),s("GET",u+"/contents"+(t?"/"+t:""),{ref:e},n)},this.fork=function(e){s("POST",u+"/forks",null,e)},this.branch=function(e,t,n){2===arguments.length&&"function"==typeof arguments[1]&&(n=t,t=e,e="master"),this.getRef("heads/"+e,function(e,i){return e&&n?n(e):void a.createRef({ref:"refs/heads/"+t,sha:i},n)})},this.createPullRequest=function(e,t){s("POST",u+"/pulls",e,t)},this.listHooks=function(e){s("GET",u+"/hooks",null,e)},this.getHook=function(e,t){s("GET",u+"/hooks/"+e,null,t)},this.createHook=function(e,t){s("POST",u+"/hooks",e,t)},this.editHook=function(e,t,n){s("PATCH",u+"/hooks/"+e,t,n)},this.deleteHook=function(e,t){s("DELETE",u+"/hooks/"+e,null,t)},this.read=function(e,t,n){s("GET",u+"/contents/"+encodeURI(t)+(e?"?ref="+e:""),null,function(e,t){return e&&404===e.error?n("not found",null,null):e?n(e):void n(null,t)},!0)},this.remove=function(e,t,n){a.getSha(e,t,function(i,o){return i?n(i):void s("DELETE",u+"/contents/"+t,{message:t+" is removed",sha:o,branch:e},n)})},this["delete"]=function(e,t,n){a.getSha(e,t,function(i,o){if(!o)return n("not found",null);var r=u+"/contents/"+t,a={message:"Deleted "+t,sha:o};r+="?message="+encodeURIComponent(a.message),r+="&sha="+encodeURIComponent(a.sha),r+="&branch="+encodeURIComponent(e),s("DELETE",r,null,n)})},this.move=function(e,t,n,s){i(e,function(i,o){a.getTree(o+"?recursive=true",function(i,r){r.forEach(function(e){e.path===t&&(e.path=n),"tree"===e.type&&delete e.sha}),a.postTree(r,function(n,i){a.commit(o,i,"Deleted "+t,function(t,n){a.updateHead(e,n,function(e){s(e)})})})})})},this.write=function(e,n,i,o,r){a.getSha(e,encodeURI(n),function(a,l){return a&&404!==a.error?r(a):void s("PUT",u+"/contents/"+encodeURI(n),{message:o,content:t(i),branch:e,sha:l},r)})},this.getCommits=function(e,t){e=e||{};var n=u+"/commits",i=[];if(e.sha&&i.push("sha="+encodeURIComponent(e.sha)),e.path&&i.push("path="+encodeURIComponent(e.path)),e.since){var o=e.since;o.constructor===Date&&(o=o.toISOString()),i.push("since="+encodeURIComponent(o))}if(e.until){var r=e.until;r.constructor===Date&&(r=r.toISOString()),i.push("until="+encodeURIComponent(r))}e.page&&i.push("page="+e.page),e.perpage&&i.push("per_page="+e.perpage),i.length>0&&(n+="?"+i.join("&")),s("GET",n,null,t)}},n.Gist=function(e){var t=e.id,n="/gists/"+t;this.read=function(e){s("GET",n,null,function(t,n){e(t,n)})},this.create=function(e,t){s("POST","/gists",e,t)},this["delete"]=function(e){s("DELETE",n,null,function(t,n){e(t,n)})},this.fork=function(e){s("POST",n+"/fork",null,function(t,n){e(t,n)})},this.update=function(e,t){s("PATCH",n,e,function(e,n){t(e,n)})},this.star=function(e){s("PUT",n+"/star",null,function(t,n){e(t,n)})},this.unstar=function(e){s("DELETE",n+"/star",null,function(t,n){e(t,n)})},this.isStarred=function(e){s("GET",n+"/star",null,function(t,n){e(t,n)})}},n.Issue=function(e){var t="/repos/"+e.user+"/"+e.repo+"/issues";this.list=function(e,n){var i=[];for(var s in e)e.hasOwnProperty(s)&&i.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));o(t+"?"+i.join("&"),n)}},this.getIssues=function(e,t){return new n.Issue({user:e,repo:t})},this.getRepo=function(e,t){return new n.Repository({user:e,name:t})},this.getUser=function(){return new n.User},this.getGist=function(e){return new n.Gist({id:e})}};"undefined"!=typeof exports?module.exports=n:window.Github=n}).call(this),function(e){"use strict";var t=function(t){var n=this;$(document).ajaxStart(function(){NProgress.start()}),$(document).ajaxStop(function(){NProgress.done()}),this.github=null,this.gistUrl="https://gist.github.com/",this.blocksUrl="http://bl.ocks.org/";var i=localStorage.getItem("github");if(console.log("token",i),i)console.log("token already exists!"),this.github=new Github({token:i,auth:"oauth"}),$.getJSON("https://api.github.com/user?access_token="+i,function(e){$("#login").html("Hello, "+e.login).attr("href","#"),n.user=e.login});else{var s=this.getQueryString();if(s.code){console.log("code:",s.code);var o=s.code;$.getJSON("https://whispering-stream-9425.herokuapp.com/authenticate/"+o,function(t){console.log("Token CREATED: ",t),localStorage.setItem("github",t.token),$.getJSON("https://api.github.com/user?access_token="+t.token,function(e){$("#login").html("Hello, "+e.login).attr("href","#"),n.user=e.login}),n.github=new Github({token:t.token,auth:"oauth"}),delete s.code,s=n.setQueryString(s),e.history.pushState("","","?"+s)})}else s.edit&&(delete s.edit,s=n.setQueryString(s),e.history.pushState("","","?"+s)),n.github=new Github({})}this.map=null,this.layers=[],this.extent=[[-115.85,-38.82],[119.25,52.58]],this.snippet="Example Webmap",this.title="New Map",this.webmap={},this.defaultWebMap={},this.defaultWebMap.item={title:this.title,snippet:this.snippet,extent:this.extent},this.defaultWebMap.itemData={baseMap:{baseMapLayers:[{opacity:1,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer"},{opacity:.3,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}],title:"basemap"},version:"1.0"},this.getWebMap(function(){n._setDefaultRenderers(),n._initMap(),n._wire()});new OpenSearch("search-container",{})};t.prototype.getWebMap=function(e){var t,n,i=this;if(this.github){var s=this.getQueryString(),o=s.gistId||null,r=s.mapId||this.guid;o&&r?(n=this.github.getGist(o),n.read(function(n,s){_.each(s.files,function(e){e.filename===r&&(t=JSON.parse(e.content))}),console.log("json",t),t?(i.webmap=t,i._layersFromWebMapJson()):i.webmap=i.defaultWebMap,e()})):(i.webmap=i.defaultWebMap,e())}else i.webmap=i.defaultWebMap,e()},t.prototype._initMap=function(){var e=this;this._updateGistUrl(),this._updateBlocksUrl(),require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],function(t,n,i,s,o,r){e.FeatureLayer=s,e.SimpleRenderer=o,e.jsonUtils=r,e.map,i.createMap(e.webmap,"map",{mapOptions:{minZoom:2}}).then(function(t){e.map=t.map,e.map.graphicsLayerIds.forEach(function(t){var t=e.map.getLayer(t);t.setMinScale(0),t.setMaxScale(0),t.redraw(),e.snippet=t.name}),e.map.on("extent-change",function(){e._updateExtent()})})})},t.prototype.addLayerToMap=function(t,n){var i,s=this;this.malette&&this.malette.destroy();var o=new this.FeatureLayer(t,{mode:this.FeatureLayer.MODE_ONDEMAND,outFields:["*"]});this.map.addLayer(o),this.layers.push({url:t,visibility:!0,opacity:.78,mode:1,title:o.name,id:o.id,minScale:0,maxScale:0,layerDefinition:{drawingInfo:{renderer:{}}}}),o.on("load",function(){switch(o.minScale=0,o.maxScale=0,s.snippet=o.name,console.log("layer loaded!",o),o.geometryType){case"esriGeometryPoint":i="point";break;case"esriGeometryPolygon":i="polygon";break;default:i="point"}var r=s.isWebMercator(o.spatialReference);r?s.map.setExtent(o.fullExtent.expand(2),!1):s.projectGeometries(o.fullExtent.spatialReference.wkid,102100,"esriGeometryEnvelope",o.fullExtent).done(function(e){var t=e.geometries[0];t.spatialReference={wkid:102100};var n=new esri.geometry.Extent(t);s.map.setExtent(n.expand(2),!1)});var a=s.renderers[i],u=new s.SimpleRenderer(a);o.setRenderer(u),o.redraw(),s._updateLayers(t,u),s.save(),$.getJSON("http://opendata.arcgis.com/datasets/"+n+".json",function(n){var r=n.data.fields,u=n.data.name;s.malette=new Malette("map",{title:u,style:a,formatIn:"esri-json",formatOut:"esri-json",fields:r,type:i,exportStyle:!0}),e.malette=s.malette,"polygon"===i?setTimeout(function(){$("#malette-theme-color-option").trigger("click")},100):"point"===i&&setTimeout(function(){$("#malette-size-tab").trigger("click"),$("#malette-graduated-size-option").trigger("click")},100),s.malette.on("style-change",function(e){console.log("exported style",e);var n=s.jsonUtils.fromJson(e);o.setRenderer(n),o.redraw(),s._updateLayers(t,n),s.save()})})})},t.prototype._layersFromWebMapJson=function(){var e=this;this.webmap.itemData.operationalLayers.forEach(function(t){var n={};n.url=t.url,n.visibility=t.visibility,n.opacity=t.opacity,n.layerDefinition=t.layerDefinition,n.mode=t.mode,n.id=t.id,e.layers.push(n)})},t.prototype._updateLayers=function(e,t){this.layers.forEach(function(n){n.url===e&&(n.layerDefinition.drawingInfo.renderer=t.toJson())})},t.prototype._updateExtent=function(){var e=this.map.geographicExtent;this.extent=[[e.xmin,e.ymin],[e.xmax,e.ymax]],this.save()},t.prototype.getBasemapLayers=function(){var e=[];return this.webmap.itemData.baseMap.baseMapLayers.forEach(function(t){var n={};n.opacity=t.opacity,n.visibility=t.visibility,n.url=t.url,e.push(n)}),e},t.prototype._buildWebMapJson=function(){var e={},t=this.getBasemapLayers();return e.item={title:this.title,snippet:this.snippet,extent:this.extent},e.itemData={operationalLayers:this.layers,baseMap:{baseMapLayers:t,title:"basemap"},version:"1.0"},console.log("web map json: ",e),e},t.prototype.save=function(){var t=this,n=this._buildWebMapJson(),i=this.getQueryString(),s=i.gistId||null,o=i.mapId||this.guid();$("#save-text").html("Saving...");var r={description:this.snippet,"public":!0,files:{}};if(r.files[o]={content:JSON.stringify(n)},s){var a=this.github.getGist(s);r.files["index.html"]={content:this._getTemplate(s)},a.update(r,function(e,n){t._onSaveComplete(),t._updateGistUrl(),t._updateBlocksUrl()})}else{var a=this.github.getGist();a.create(r,function(n,s){console.log("gist",s),i.mapId=o,i.gistId=s.id,i=t.setQueryString(i),e.history.pushState("","","?"+i),t._onSaveComplete(),t._updateGistUrl(),t._updateBlocksUrl()})}},t.prototype._onSaveComplete=function(){$("#save-text").html("Save")},t.prototype.clearLayers=function(){var e=this;$("#style-map").addClass("disabled"),this.malette&&(this.malette.destroy(),this.malette=null),this.map.graphicsLayerIds.forEach(function(t){e.map.removeLayer(e.map.getLayer(t))}),this.layers=[],this.save()},t.prototype.guid=function(){return Math.random().toString(36).substr(2,9)},t.prototype.setQueryString=function(e){return $.param(e)},t.prototype.getQueryString=function(){var t,n,i=e.location.search.substring(1).split("&"),s={};for(n in i)""!==i[n]&&(t=i[n].split("="),s[decodeURIComponent(t[0])]=decodeURIComponent(t[1]));return s},t.prototype.isWebMercator=function(e){var t=[102100,102113,3857],n=!1;return t.forEach(function(t){(e.wkid===t||e.latestWkid===t)&&(n=!0)}),n},t.prototype.projectGeometries=function(e,t,n,i){var s="http://utilitydev.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer/project",o={geometryType:n,geometries:[i]},r={geometries:JSON.stringify(o),transformForward:!1,transformation:"",inSR:e,outSR:t,f:"json"},a={url:s,method:"POST",data:r,dataType:"json"};return $.ajax(a)},t.prototype._setDefaultRenderers=function(){this.renderers={point:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:1.3,type:"esriSLS",style:"esriSLSSolid"}}},polygon:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,style:"esriSFSSolid",type:"esriSFS",outline:{color:[255,255,255,255],width:.5,type:"esriSLS",style:"esriSLSSolid"}}}}},t.prototype._updateGistUrl=function(){var e=this,t=this.getQueryString(),n=t.gistId;e.user&&n?($("#footer-urls").show(),$("#gist-url").show().attr("href",e.gistUrl+e.user+"/"+n).html(e.gistUrl+e.user+"/"+n)):$("#footer-urls").hide()},t.prototype._updateBlocksUrl=function(){var e=this,t=this.getQueryString(),n=t.gistId;e.user&&n?($("#footer-urls").show(),$("#blocks-url").attr("href",e.blocksUrl+e.user+"/"+n).html(e.blocksUrl+e.user+"/"+n)):$("#footer-urls").hide()},t.prototype._getTemplate=function(e){var t='<!DOCTYPE html>      <meta charset="utf-8">      <link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">      <style>        #map {          height:500px;        }      </style>      <body>      <div id="map"></div>      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>      <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>      <script src="http://js.arcgis.com/3.14/"></script>      <script>      require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],        function(Map,urlUtils,arcgisUtils,FeatureLayer,SimpleRenderer,jsonUtils) {        $.getJSON("https://api.github.com/gists/'+e+'", function(data) {          var webmap;          for (var file in data.files ) {            if ( file !== "index.html" ) {              webmap = JSON.parse(data.files[file].content);            }          };          arcgisUtils.createMap(webmap, "map").then(function(response){            var map = response.map;            map.graphicsLayerIds.forEach(function(layer) {              var layer = map.getLayer(layer);              layer.setMinScale(0);              layer.setMaxScale(0);              layer.redraw();            });          });        });      });      </script>      </body>';return t},t.prototype._wire=function(){var e=this;console.log("wire me");var t=this.getQueryString();"true"===t.edit&&$(".tool").show(),$("#clear-layers").on("click",function(){e.clearLayers()}),$("#add-data").on("click",function(){$("#search-container").toggle()}),$("#save-map").on("click",function(){e.save()}),$("#map").on("dragover",function(e){e.preventDefault()}),this.layers.length&&$("#style-map").removeClass("disabled"),$("#style-map").on("click",function(){$(this).hasClass("disabled")||e.showMalette()}),$("#map").on("drop",function(t){var n=t.originalEvent.dataTransfer.getData("text"),i=n.split(","),s=i[0],o=i[1];$("#search-container").hide(),e.addLayerToMap(s,o)})},e.App=t}(window);