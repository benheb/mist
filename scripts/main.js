(function(){"use strict";var e,t;"undefined"!=typeof exports?(e=require("xmlhttprequest").XMLHttpRequest,"undefined"==typeof t&&(t=require("btoa"))):t=window.btoa,"undefined"!=typeof window&&"undefined"!=typeof window.XMLHttpRequest&&(e=window.XMLHttpRequest);var i=function(n){function s(i,s,r,o,l,u){function c(){var e=s.indexOf("//")>=0?s:a+s;return e+=/\?/.test(e)?"&":"?",r&&"object"==typeof r&&["GET","HEAD"].indexOf(i)>-1&&(e+="&"+Object.keys(r).map(function(e){return e+"="+r[e]}).join("&")),e+"&"+(new Date).getTime()}var p=new e;if(p.open(i,c(),!u),u||(p.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300||304===this.status?o(null,l?this.responseText:this.responseText?JSON.parse(this.responseText):!0,this):o({path:s,request:this,error:this.status}))}),l?p.setRequestHeader("Accept","application/vnd.github.v3.raw+json"):(p.dataType="json",p.setRequestHeader("Accept","application/vnd.github.v3+json")),p.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.token||n.username&&n.password){var d=n.token?"token "+n.token:"Basic "+t(n.username+":"+n.password);p.setRequestHeader("Authorization",d)}return r?p.send(JSON.stringify(r)):p.send(),u?p.response:void 0}function r(e,t){var i=[];!function n(){s("GET",e,null,function(s,r,a){if(s)return t(s);i.push.apply(i,r);var o=(a.getResponseHeader("link")||"").split(/\s*,\s*/g),l=null;o.forEach(function(e){l=/rel="next"/.test(e)?e:l}),l&&(l=(/<(.*)>/.exec(l)||[])[1]),l?(e=l,n()):t(s,i)})}()}var a=n.apiUrl||"https://api.github.com";i.User=function(){this.repos=function(e){r("/user/repos?type=all&per_page=1000&sort=updated",function(t,i){e(t,i)})},this.orgs=function(e){s("GET","/user/orgs",null,function(t,i){e(t,i)})},this.gists=function(e){s("GET","/gists",null,function(t,i){e(t,i)})},this.notifications=function(e){s("GET","/notifications",null,function(t,i){e(t,i)})},this.show=function(e,t){var i=e?"/users/"+e:"/user";s("GET",i,null,function(e,i){t(e,i)})},this.userRepos=function(e,t){r("/users/"+e+"/repos?type=all&per_page=1000&sort=updated",function(e,i){t(e,i)})},this.userGists=function(e,t){s("GET","/users/"+e+"/gists",null,function(e,i){t(e,i)})},this.orgRepos=function(e,t){r("/orgs/"+e+"/repos?type=all&&page_num=1000&sort=updated&direction=desc",function(e,i){t(e,i)})},this.follow=function(e,t){s("PUT","/user/following/"+e,null,function(e,i){t(e,i)})},this.unfollow=function(e,t){s("DELETE","/user/following/"+e,null,function(e,i){t(e,i)})},this.createRepo=function(e,t){s("POST","/user/repos",e,t)}},i.Repository=function(e){function n(e,t){return e===u.branch&&u.sha?t(null,u.sha):void o.getRef("heads/"+e,function(i,n){u.branch=e,u.sha=n,t(i,n)})}var r=e.name,a=e.user,o=this,l="/repos/"+a+"/"+r,u={branch:null,sha:null};this.deleteRepo=function(t){s("DELETE",l,e,t)},this.getRef=function(e,t){s("GET",l+"/git/refs/"+e,null,function(e,i){return e?t(e):void t(null,i.object.sha)})},this.createRef=function(e,t){s("POST",l+"/git/refs",e,t)},this.deleteRef=function(t,i){s("DELETE",l+"/git/refs/"+t,e,i)},this.createRepo=function(e,t){s("POST","/user/repos",e,t)},this.deleteRepo=function(t){s("DELETE",l,e,t)},this.listTags=function(e){s("GET",l+"/tags",null,function(t,i){return t?e(t):void e(null,i)})},this.listPulls=function(e,t){s("GET",l+"/pulls"+(e?"?state="+e:""),null,function(e,i){return e?t(e):void t(null,i)})},this.getPull=function(e,t){s("GET",l+"/pulls/"+e,null,function(e,i){return e?t(e):void t(null,i)})},this.compare=function(e,t,i){s("GET",l+"/compare/"+e+"..."+t,null,function(e,t){return e?i(e):void i(null,t)})},this.listBranches=function(e){s("GET",l+"/git/refs/heads",null,function(t,i){return t?e(t):void e(null,i.map(function(e){var t=e.ref.split("/");return t[t.length-1]}))})},this.getBlob=function(e,t){s("GET",l+"/git/blobs/"+e,null,t,"raw")},this.getCommit=function(e,t,i){s("GET",l+"/git/commits/"+t,null,function(e,t){return e?i(e):void i(null,t)})},this.getSha=function(e,t,i){return t&&""!==t?void s("GET",l+"/contents/"+t+(e?"?ref="+e:""),null,function(e,t){return e?i(e):void i(null,t.sha)}):o.getRef("heads/"+e,i)},this.getTree=function(e,t){s("GET",l+"/git/trees/"+e,null,function(e,i){return e?t(e):void t(null,i.tree)})},this.postBlob=function(e,i){e="string"==typeof e?{content:e,encoding:"utf-8"}:{content:t(String.fromCharCode.apply(null,new Uint8Array(e))),encoding:"base64"},s("POST",l+"/git/blobs",e,function(e,t){return e?i(e):void i(null,t.sha)})},this.updateTree=function(e,t,i,n){var r={base_tree:e,tree:[{path:t,mode:"100644",type:"blob",sha:i}]};s("POST",l+"/git/trees",r,function(e,t){return e?n(e):void n(null,t.sha)})},this.postTree=function(e,t){s("POST",l+"/git/trees",{tree:e},function(e,i){return e?t(e):void t(null,i.sha)})},this.commit=function(t,n,r,a){var o=new i.User;o.show(null,function(i,o){if(i)return a(i);var c={message:r,author:{name:e.user,email:o.email},parents:[t],tree:n};s("POST",l+"/git/commits",c,function(e,t){return e?a(e):(u.sha=t.sha,void a(null,t.sha))})})},this.updateHead=function(e,t,i){s("PATCH",l+"/git/refs/heads/"+e,{sha:t},function(e){i(e)})},this.show=function(e){s("GET",l,null,e)},this.contributors=function(e,t){t=t||1e3;var i=this;s("GET",l+"/stats/contributors",null,function(n,s,r){return n?e(n):void(202===r.status?setTimeout(function(){i.contributors(e,t)},t):e(n,s))})},this.contents=function(e,t,i){t=encodeURI(t),s("GET",l+"/contents"+(t?"/"+t:""),{ref:e},i)},this.fork=function(e){s("POST",l+"/forks",null,e)},this.branch=function(e,t,i){2===arguments.length&&"function"==typeof arguments[1]&&(i=t,t=e,e="master"),this.getRef("heads/"+e,function(e,n){return e&&i?i(e):void o.createRef({ref:"refs/heads/"+t,sha:n},i)})},this.createPullRequest=function(e,t){s("POST",l+"/pulls",e,t)},this.listHooks=function(e){s("GET",l+"/hooks",null,e)},this.getHook=function(e,t){s("GET",l+"/hooks/"+e,null,t)},this.createHook=function(e,t){s("POST",l+"/hooks",e,t)},this.editHook=function(e,t,i){s("PATCH",l+"/hooks/"+e,t,i)},this.deleteHook=function(e,t){s("DELETE",l+"/hooks/"+e,null,t)},this.read=function(e,t,i){s("GET",l+"/contents/"+encodeURI(t)+(e?"?ref="+e:""),null,function(e,t){return e&&404===e.error?i("not found",null,null):e?i(e):void i(null,t)},!0)},this.remove=function(e,t,i){o.getSha(e,t,function(n,r){return n?i(n):void s("DELETE",l+"/contents/"+t,{message:t+" is removed",sha:r,branch:e},i)})},this["delete"]=function(e,t,i){o.getSha(e,t,function(n,r){if(!r)return i("not found",null);var a=l+"/contents/"+t,o={message:"Deleted "+t,sha:r};a+="?message="+encodeURIComponent(o.message),a+="&sha="+encodeURIComponent(o.sha),a+="&branch="+encodeURIComponent(e),s("DELETE",a,null,i)})},this.move=function(e,t,i,s){n(e,function(n,r){o.getTree(r+"?recursive=true",function(n,a){a.forEach(function(e){e.path===t&&(e.path=i),"tree"===e.type&&delete e.sha}),o.postTree(a,function(i,n){o.commit(r,n,"Deleted "+t,function(t,i){o.updateHead(e,i,function(e){s(e)})})})})})},this.write=function(e,i,n,r,a){o.getSha(e,encodeURI(i),function(o,u){return o&&404!==o.error?a(o):void s("PUT",l+"/contents/"+encodeURI(i),{message:r,content:t(n),branch:e,sha:u},a)})},this.getCommits=function(e,t){e=e||{};var i=l+"/commits",n=[];if(e.sha&&n.push("sha="+encodeURIComponent(e.sha)),e.path&&n.push("path="+encodeURIComponent(e.path)),e.since){var r=e.since;r.constructor===Date&&(r=r.toISOString()),n.push("since="+encodeURIComponent(r))}if(e.until){var a=e.until;a.constructor===Date&&(a=a.toISOString()),n.push("until="+encodeURIComponent(a))}e.page&&n.push("page="+e.page),e.perpage&&n.push("per_page="+e.perpage),n.length>0&&(i+="?"+n.join("&")),s("GET",i,null,t)}},i.Gist=function(e){var t=e.id,i="/gists/"+t;this.read=function(e){s("GET",i,null,function(t,i){e(t,i)})},this.create=function(e,t){s("POST","/gists",e,t)},this["delete"]=function(e){s("DELETE",i,null,function(t,i){e(t,i)})},this.fork=function(e){s("POST",i+"/fork",null,function(t,i){e(t,i)})},this.update=function(e,t){s("PATCH",i,e,function(e,i){t(e,i)})},this.star=function(e){s("PUT",i+"/star",null,function(t,i){e(t,i)})},this.unstar=function(e){s("DELETE",i+"/star",null,function(t,i){e(t,i)})},this.isStarred=function(e){s("GET",i+"/star",null,function(t,i){e(t,i)})}},i.Issue=function(e){var t="/repos/"+e.user+"/"+e.repo+"/issues";this.list=function(e,i){var n=[];for(var s in e)e.hasOwnProperty(s)&&n.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));r(t+"?"+n.join("&"),i)}},this.getIssues=function(e,t){return new i.Issue({user:e,repo:t})},this.getRepo=function(e,t){return new i.Repository({user:e,name:t})},this.getUser=function(){return new i.User},this.getGist=function(e){return new i.Gist({id:e})}};"undefined"!=typeof exports?module.exports=i:window.Github=i}).call(this),function(e){"use strict";var t=function(t){var i=this;this.state={},this.state.logged_in=!1,this.state.editable=!1,this.state.editing=!1,this.github=null;var n=localStorage.getItem("github"),s=this.getQueryString();if(n)this.github=new Github({token:n,auth:"oauth"}),$.getJSON("https://api.github.com/user?access_token="+n,function(e){$("#login").html("Hello, "+e.login).attr("href","#"),i.user=e.login,i._setHeader(!0),i._isEditable(n,e.login)}),this.state.logged_in=!0;else if(s.code){var r=s.code;$.getJSON("https://whispering-stream-9425.herokuapp.com/authenticate/"+r,function(t){console.log("Token CREATED: ",t),localStorage.setItem("github",t.token),$.getJSON("https://api.github.com/user?access_token="+t.token,function(e){$("#login").html("Hello, "+e.login).attr("href","#"),i.user=e.login,i._setHeader(!0)}),i.github=new Github({token:t.token,auth:"oauth"}),i.state.logged_in=!0,delete s.code,s=i.setQueryString(s),e.history.pushState("","","?"+s)})}else s.edit&&(delete s.edit,s=i.setQueryString(s),e.history.pushState("","","?"+s)),i.github=new Github({});$(document).ajaxStart(function(){NProgress.start()}),$(document).ajaxStop(function(){NProgress.done()}),this.gistUrl="https://gist.github.com/",this.blocksUrl="http://bl.ocks.org/",this._setHeader(!0),this.map=null,this.layers=[],this.basemapLayers=[],this.extent=[[-115.85,-38.82],[119.25,52.58]],this.snippet="Example Webmap",this.title="New Map",this.webmap={},this._createDefaultWebmap(),this.basemapUrls={delorme:"http://services.arcgisonline.com/arcgis/rest/services/Specialty/DeLorme_World_Base_Map/MapServer",gray:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer",dark:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer"},this.getWebMap(function(){i._setDefaultRenderers(),i._initMap(),i._wire()});new OpenSearch("search-container",{});this.legend=new Legend("legend-container",{editable:!1,layers:[]}),this.legend.on("remove-layer",function(e){i.removeLayerFromMap(e)}),this.legend.on("edit-layer",function(e){var t=i.map.getLayer(e);$.getJSON("http://opendata.arcgis.com/datasets/"+e+".json",function(e){var n=e.data.fields,s=(e.data.name,{});s.json=t.renderer.toJson(),s.name=t.name,s.fields=n,s.type=i.getType(t),s.layerId=t.id,i.initMalette(s)})}),this.legend.on("edit-layer-end",function(e){i.malette&&(i.malette.destroy(),i.malette=null)})};t.prototype.getWebMap=function(e){var t,i,n=this;if(this.github){var s=this.getQueryString(),r=s.id||null;r?(i=this.github.getGist(r),i.read(function(i,s){_.each(s.files,function(e){"webmap.json"===e.filename&&(t=JSON.parse(e.content))}),t?(n.webmap=t,n._layersFromWebMapJson()):n.webmap=n.defaultWebMap,n._basemapsFromWebMapJson(),e()})):(n.webmap=n.defaultWebMap,n._basemapsFromWebMapJson(),e())}else n.webmap=n.defaultWebMap,n._basemapsFromWebMapJson(),e()},t.prototype._initMap=function(){var e=this;this._updateGistUrl(),this._updateBlocksUrl(),require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],function(t,i,n,s,r,a){e.FeatureLayer=s,e.SimpleRenderer=r,e.jsonUtils=a,e.map,n.createMap(e.webmap,"map",{mapOptions:{minZoom:2}}).then(function(t){if(e.map=t.map,e._updateExtent(),e.map.graphicsLayerIds.forEach(function(t){var t=e.map.getLayer(t);t.setMinScale(0),t.setMaxScale(0),t.redraw(),e.snippet=t.name,e.legend.addLayer({id:t.id,name:t.name,renderer:t.renderer.toJson()})}),e.map.on("extent-change",function(){e._updateExtent()}),e.state.editing&&e.map.graphicsLayerIds.length){var i=e.map.graphicsLayerIds[0],n=e.map.getLayer(i);$.getJSON("http://opendata.arcgis.com/datasets/"+i+".json",function(t){var i=t.data.fields,s=(t.data.name,{});s.json=n.renderer.toJson(),s.name=n.name,s.fields=i,s.type=e.getType(n),s.layerId=n.id,e.initMalette(s),e._maletteTriggers(e.getType(n))})}})})},t.prototype.addLayerToMap=function(e,t){var i,n=this,s=new this.FeatureLayer(e,{mode:this.FeatureLayer.MODE_ONDEMAND,outFields:["*"]});s.id=t,this.map.addLayer(s),this.layers.push({url:e,visibility:!0,opacity:.78,mode:1,title:s.name,id:s.id,minScale:0,maxScale:0,layerDefinition:{drawingInfo:{renderer:{}}}}),s.on("load",function(){console.log("layer loaded!",s),s.minScale=0,s.maxScale=0,n.snippet=s.name,i=n.getType(s);var r=n.isWebMercator(s.spatialReference);r?n.map.setExtent(s.fullExtent.expand(2),!1):n.projectGeometries(s.fullExtent.spatialReference.wkid,102100,"esriGeometryEnvelope",s.fullExtent).done(function(e){var t=e.geometries[0];t.spatialReference={wkid:102100};var i=new esri.geometry.Extent(t);n.map.setExtent(i.expand(2),!1)});var a=n.renderers[i],o=new n.SimpleRenderer(a);s.setRenderer(o),s.redraw(),n.legend.addLayer({id:s.id,name:s.name,renderer:a}),n._updateLayers(e,o),n.save(),$.getJSON("http://opendata.arcgis.com/datasets/"+t+".json",function(e){var t=e.data.fields,r=e.data.name,o={};o.json=a,o.name=r,o.fields=t,o.type=i,o.layerId=s.id,n.initMalette(o),n._maletteTriggers(i)})})},t.prototype.removeLayerFromMap=function(e){var t=this;this.malette&&(this.malette.destroy(),this.malette=null),this.layers.forEach(function(i,n){i.id===e&&t.layers.splice(n,1)}),this.map.removeLayer(this.map.getLayer(e)),this.save(!0)},t.prototype.initMalette=function(e){var t=this;this.malette&&this.malette.destroy(),this.malette=new Malette("map",{title:e.name,style:e.json,formatIn:"esri-json",formatOut:"esri-json",fields:e.fields,type:e.type,exportStyle:!0,layerId:e.layerId}),this.malette.on("style-change",function(e){console.log("exported style",e);var i;if(e.layerId){i=t.map.getLayer(e.layerId);var n=t.jsonUtils.fromJson(e);i.setRenderer(n),i.redraw(),t._updateLegend(i,e),t._updateLayers(i.url,n),t.save()}})},t.prototype._maletteTriggers=function(e){"polygon"===e?setTimeout(function(){$("#malette-theme-color-option").trigger("click")},100):"point"===e&&setTimeout(function(){$("#malette-size-tab").trigger("click"),$("#malette-graduated-size-option").trigger("click")},100)},t.prototype._changeBasemap=function(e){var t=this;switch(this.map.getLayer("base0").setVisibility(),this.map.getLayer("base1").setVisibility(),this.map.getLayer("base2").setVisibility(),e){case"delorme":t.map.getLayer("base0").setVisibility(!0);break;case"gray":t.map.getLayer("base1").setVisibility(!0);break;case"dark":t.map.getLayer("base2").setVisibility(!0)}this.basemapLayers.forEach(function(i){i.visibility=i.url===t.basemapUrls[e]?!0:!1}),this.save()},t.prototype._updateLayers=function(e,t){this.layers.forEach(function(i){i.url===e&&(i.layerDefinition.drawingInfo.renderer=t.toJson())})},t.prototype._updateExtent=function(){var e=this.map.geographicExtent;this.extent=[[e.xmin,e.ymin],[e.xmax,e.ymax]],this.save()},t.prototype._updateLegend=function(e,t){e.id;this.legend.updateLayer({id:e.id,name:e.name,renderer:e.renderer.toJson()})},t.prototype.save=function(t){if(this.state.editing&&this.state.logged_in&&(0!==this.layers.length||t)){var i=this,n={};n.title=this.title,n.snippet=this.snippet,n.extent=this.extent,n.layers=this.layers,n.basemapLayers=this.basemapLayers,this._assureJson();var s=this._buildWebMapJson(n),r=this.getQueryString();this._onSave();var a=r.id||null,o={description:this.snippet,"public":!0,files:{}};if(o.files["webmap.json"]={content:JSON.stringify(s,null,"	")},a){var l=this.github.getGist(a);o.files["index.html"]={content:this._getTemplate(a)},l.update(o,function(e,t){i._onSaveComplete(),i._updateGistUrl(),i._updateBlocksUrl()})}else{var l=this.github.getGist();l.create(o,function(t,n){r.id=n.id,r=i.setQueryString(r),e.history.pushState("","","?"+r),i._onSaveComplete(),i._updateGistUrl(),i._updateBlocksUrl()})}}},t.prototype.clearLayers=function(){var e=this;$("#style-map").addClass("disabled"),this.malette&&(this.malette.destroy(),this.malette=null);var t=[];this.map.graphicsLayerIds.forEach(function(e){t.push(e)}),t.forEach(function(t){e.map.removeLayer(e.map.getLayer(t))}),this.layers=[],this.save(!0)},t.prototype._onSave=function(){$("#save-text").html("Saving...")},t.prototype._onSaveComplete=function(){$("#save-text").html("Save")},t.prototype.guid=function(){return Math.random().toString(36).substr(2,9)},t.prototype.setQueryString=function(e){return $.param(e)},t.prototype.getQueryString=function(){var t,i,n=e.location.search.substring(1).split("&"),s={};for(i in n)""!==n[i]&&(t=n[i].split("="),s[decodeURIComponent(t[0])]=decodeURIComponent(t[1]));return s},t.prototype.getType=function(e){var t;switch(e.geometryType){case"esriGeometryPoint":t="point";break;case"esriGeometryPolygon":t="polygon";break;default:t="point"}return t},t.prototype.isWebMercator=function(e){var t=[102100,102113,3857],i=!1;return t.forEach(function(t){(e.wkid===t||e.latestWkid===t)&&(i=!0)}),i},t.prototype.projectGeometries=function(e,t,i,n){var s="http://utilitydev.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer/project",r={geometryType:i,geometries:[n]},a={geometries:JSON.stringify(r),transformForward:!1,transformation:"",inSR:e,outSR:t,f:"json"},o={url:s,method:"POST",data:a,dataType:"json"};return $.ajax(o)},t.prototype._setDefaultRenderers=function(){this.renderers={point:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:1.3,type:"esriSLS",style:"esriSLSSolid"}}},polygon:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,style:"esriSFSSolid",type:"esriSFS",outline:{color:[255,255,255,255],width:.5,type:"esriSLS",style:"esriSLSSolid"}}}}},t.prototype._setHeader=function(e){var t=this.getQueryString(),i=localStorage.getItem("github");e?(this.legend&&this.legend.enableEdit(),t.edit&&i&&(this.state.editing=!0,this.state.logged_in=!0),this.state.logged_in&&this.state.editing&&$(".tool").show(),!this.state.editing&&i?($("#new").hide(),$("#edit").show()):($("#new").hide(),$("#edit").hide()),this.state.editing&&i&&$("#new").show()):($(".tool").hide(),$("#new").hide(),$("#edit").hide(),i&&$("#new").show(),this.legend&&this.legend.disableEdit())},t.prototype._isEditable=function(t,i){var n=this,s=this.getQueryString();if(s.id&&t){var r=this.github.getGist(s.id);r.read(function(t,r){r.owner.login!==i&&(n.state.editable=!1,n.state.editing=!1,s.edit&&(delete s.edit,s=n.setQueryString(s),e.history.pushState("","","?"+s)),n._setHeader(!1))})}},t.prototype._updateGistUrl=function(){var e=this,t=this.getQueryString(),i=t.id;e.user&&i?($("#footer-urls").show(),$("#gist-url").show().attr("href",e.gistUrl+e.user+"/"+i).html(e.gistUrl+e.user+"/"+i)):$("#footer-urls").hide()},t.prototype._updateBlocksUrl=function(){var e=this,t=this.getQueryString(),i=t.id;e.user&&i?($("#footer-urls").show(),$("#blocks-url").attr("href",e.blocksUrl+e.user+"/"+i).html(e.blocksUrl+e.user+"/"+i)):$("#footer-urls").hide()},t.prototype._getTemplate=function(e){var t='<!DOCTYPE html>      <meta charset="utf-8">      <link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">      <link rel="stylesheet" type="text/css" href="https://rawgit.com/benheb/legend/master/legend.css">      <title>Webmap created with Mundi</title>      <style>        #map {          height:500px;        }        #mundi-link {          position: absolute;          right: 5px;          z-index: 200;          display: block;          background: #FFF;          text-decoration: none;          color: #4C4C4C;          top: 5px;          padding: 5px;          border-radius: 2px;        }        #legend-container {          width: 218px;          position: absolute;          bottom: 20px;          left: 13px;        }      </style>      <body>      <div id="map">        <a id="mundi-link" href="http://benheb.github.io/mundi/?id='+e+'" target="_blank">View map in Mundi</a>        <div id="legend-container"></div>      </div>      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>      <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>      <script src="http://js.arcgis.com/3.14/"></script>      <script src="https://rawgit.com/benheb/legend/master/legend.js"></script>      <script>      require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],        function(Map,urlUtils,arcgisUtils,FeatureLayer,SimpleRenderer,jsonUtils) {        var legend = new Legend("legend-container", {          editable: false,          layers: []        });        $.getJSON("https://api.github.com/gists/'+e+'", function(data) {          var webmap;          for (var file in data.files ) {            if ( file !== "index.html" ) {              webmap = JSON.parse(data.files[file].content);            }          };          arcgisUtils.createMap(webmap, "map").then(function(response){            var map = response.map;            map.graphicsLayerIds.forEach(function(layer) {              var layer = map.getLayer(layer);              layer.setMinScale(0);              layer.setMaxScale(0);              layer.redraw();              legend.addLayer({                "id": layer.id,                "name": layer.name,                "renderer": layer.renderer.toJson()              });            });          });        });      });      </script>      </body>',i={indent:"auto","indent-spaces":2,quiet:"yes","tidy-mark":"no"};return t=tidy_html5(t,i)},t.prototype._wire=function(){var t=this;console.log("wire me");var i=this.getQueryString();"true"===i.edit&&$(".tool").show(),$("#clear-layers").on("click",function(){t.clearLayers()}),$("#add-data").on("click",function(){$("#search-container").toggle()}),$("#save-map").on("click",function(){t.save()}),$("#map").on("dragover",function(e){e.preventDefault()}),this.layers.length&&$("#style-map").removeClass("disabled"),$("#style-map").on("click",function(){$(this).hasClass("disabled")||t.showMalette()}),$("#map").on("drop",function(e){var i=e.originalEvent.dataTransfer.getData("text"),n=i.split(","),s=n[0],r=n[1];$("#search-container").hide(),t.addLayerToMap(s,r)}),$("#edit").on("click",function(){var i=t.getQueryString();i.edit="true",i=t.setQueryString(i),e.history.pushState("","","?"+i),t._setHeader(!0),t.state.editing=!0}),$("#new").on("click",function(){var i=t.setQueryString({edit:!0});e.history.pushState("","","?"+i),location.reload()}),$(".change-basemap").on("click",function(e){var i=$(this).attr("id");t._changeBasemap(i)})},e.App=t}(window),App.prototype._createDefaultWebmap=function(){this.defaultWebMap={},this.defaultWebMap.item={title:this.title,snippet:this.snippet,extent:this.extent},this.defaultWebMap.itemData={baseMap:{baseMapLayers:[{opacity:.5,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Specialty/DeLorme_World_Base_Map/MapServer"},{opacity:.8,visibility:!1,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer"},{opacity:1,visibility:!1,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Dark_Gray_Base/MapServer"}],title:"basemap"},version:"1.0"}},App.prototype._buildWebMapJson=function(e){var t={};return t.item={title:e.title,snippet:e.snippet,extent:e.extent},t.itemData={operationalLayers:e.layers,baseMap:{baseMapLayers:e.basemapLayers,title:"basemap"},version:"1.0"},console.log("web map json: ",t),t},App.prototype._basemapsFromWebMapJson=function(){var e=this;this.webmap.itemData.baseMap.baseMapLayers.forEach(function(t){var i={};i.opacity=t.opacity,i.visibility=t.visibility,i.url=t.url,e.basemapLayers.push(i)})},App.prototype._layersFromWebMapJson=function(){var e=this;this.webmap.itemData.operationalLayers.forEach(function(t){var i={};i.url=t.url,i.visibility=t.visibility,i.opacity=t.opacity,i.layerDefinition=t.layerDefinition,i.mode=t.mode,i.id=t.id,e.layers.push(i)})},App.prototype._assureJson=function(){var e=this;this.layers.forEach(function(t,i){var n=e.jsonUtils.fromJson(e.layers[i].layerDefinition.drawingInfo.renderer);e.layers[i].layerDefinition.drawingInfo.renderer=n.toJson()})};