(function(){"use strict";var t,e;"undefined"!=typeof exports?(t=require("xmlhttprequest").XMLHttpRequest,"undefined"==typeof e&&(e=require("btoa"))):e=window.btoa,"undefined"!=typeof window&&"undefined"!=typeof window.XMLHttpRequest&&(t=window.XMLHttpRequest);var n=function(i){function o(n,o,s,a,u,l){function c(){var t=o.indexOf("//")>=0?o:r+o;return t+=/\?/.test(t)?"&":"?",s&&"object"==typeof s&&["GET","HEAD"].indexOf(n)>-1&&(t+="&"+Object.keys(s).map(function(t){return t+"="+s[t]}).join("&")),t+"&"+(new Date).getTime()}var p=new t;if(p.open(n,c(),!l),l||(p.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300||304===this.status?a(null,u?this.responseText:this.responseText?JSON.parse(this.responseText):!0,this):a({path:o,request:this,error:this.status}))}),u?p.setRequestHeader("Accept","application/vnd.github.v3.raw+json"):(p.dataType="json",p.setRequestHeader("Accept","application/vnd.github.v3+json")),p.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.token||i.username&&i.password){var h=i.token?"token "+i.token:"Basic "+e(i.username+":"+i.password);p.setRequestHeader("Authorization",h)}return s?p.send(JSON.stringify(s)):p.send(),l?p.response:void 0}function s(t,e){var n=[];!function i(){o("GET",t,null,function(o,s,r){if(o)return e(o);n.push.apply(n,s);var a=(r.getResponseHeader("link")||"").split(/\s*,\s*/g),u=null;a.forEach(function(t){u=/rel="next"/.test(t)?t:u}),u&&(u=(/<(.*)>/.exec(u)||[])[1]),u?(t=u,i()):e(o,n)})}()}var r=i.apiUrl||"https://api.github.com";n.User=function(){this.repos=function(t){s("/user/repos?type=all&per_page=1000&sort=updated",function(e,n){t(e,n)})},this.orgs=function(t){o("GET","/user/orgs",null,function(e,n){t(e,n)})},this.gists=function(t){o("GET","/gists",null,function(e,n){t(e,n)})},this.notifications=function(t){o("GET","/notifications",null,function(e,n){t(e,n)})},this.show=function(t,e){var n=t?"/users/"+t:"/user";o("GET",n,null,function(t,n){e(t,n)})},this.userRepos=function(t,e){s("/users/"+t+"/repos?type=all&per_page=1000&sort=updated",function(t,n){e(t,n)})},this.userGists=function(t,e){o("GET","/users/"+t+"/gists",null,function(t,n){e(t,n)})},this.orgRepos=function(t,e){s("/orgs/"+t+"/repos?type=all&&page_num=1000&sort=updated&direction=desc",function(t,n){e(t,n)})},this.follow=function(t,e){o("PUT","/user/following/"+t,null,function(t,n){e(t,n)})},this.unfollow=function(t,e){o("DELETE","/user/following/"+t,null,function(t,n){e(t,n)})},this.createRepo=function(t,e){o("POST","/user/repos",t,e)}},n.Repository=function(t){function i(t,e){return t===l.branch&&l.sha?e(null,l.sha):void a.getRef("heads/"+t,function(n,i){l.branch=t,l.sha=i,e(n,i)})}var s=t.name,r=t.user,a=this,u="/repos/"+r+"/"+s,l={branch:null,sha:null};this.deleteRepo=function(e){o("DELETE",u,t,e)},this.getRef=function(t,e){o("GET",u+"/git/refs/"+t,null,function(t,n){return t?e(t):void e(null,n.object.sha)})},this.createRef=function(t,e){o("POST",u+"/git/refs",t,e)},this.deleteRef=function(e,n){o("DELETE",u+"/git/refs/"+e,t,n)},this.createRepo=function(t,e){o("POST","/user/repos",t,e)},this.deleteRepo=function(e){o("DELETE",u,t,e)},this.listTags=function(t){o("GET",u+"/tags",null,function(e,n){return e?t(e):void t(null,n)})},this.listPulls=function(t,e){o("GET",u+"/pulls"+(t?"?state="+t:""),null,function(t,n){return t?e(t):void e(null,n)})},this.getPull=function(t,e){o("GET",u+"/pulls/"+t,null,function(t,n){return t?e(t):void e(null,n)})},this.compare=function(t,e,n){o("GET",u+"/compare/"+t+"..."+e,null,function(t,e){return t?n(t):void n(null,e)})},this.listBranches=function(t){o("GET",u+"/git/refs/heads",null,function(e,n){return e?t(e):void t(null,n.map(function(t){var e=t.ref.split("/");return e[e.length-1]}))})},this.getBlob=function(t,e){o("GET",u+"/git/blobs/"+t,null,e,"raw")},this.getCommit=function(t,e,n){o("GET",u+"/git/commits/"+e,null,function(t,e){return t?n(t):void n(null,e)})},this.getSha=function(t,e,n){return e&&""!==e?void o("GET",u+"/contents/"+e+(t?"?ref="+t:""),null,function(t,e){return t?n(t):void n(null,e.sha)}):a.getRef("heads/"+t,n)},this.getTree=function(t,e){o("GET",u+"/git/trees/"+t,null,function(t,n){return t?e(t):void e(null,n.tree)})},this.postBlob=function(t,n){t="string"==typeof t?{content:t,encoding:"utf-8"}:{content:e(String.fromCharCode.apply(null,new Uint8Array(t))),encoding:"base64"},o("POST",u+"/git/blobs",t,function(t,e){return t?n(t):void n(null,e.sha)})},this.updateTree=function(t,e,n,i){var s={base_tree:t,tree:[{path:e,mode:"100644",type:"blob",sha:n}]};o("POST",u+"/git/trees",s,function(t,e){return t?i(t):void i(null,e.sha)})},this.postTree=function(t,e){o("POST",u+"/git/trees",{tree:t},function(t,n){return t?e(t):void e(null,n.sha)})},this.commit=function(e,i,s,r){var a=new n.User;a.show(null,function(n,a){if(n)return r(n);var c={message:s,author:{name:t.user,email:a.email},parents:[e],tree:i};o("POST",u+"/git/commits",c,function(t,e){return t?r(t):(l.sha=e.sha,void r(null,e.sha))})})},this.updateHead=function(t,e,n){o("PATCH",u+"/git/refs/heads/"+t,{sha:e},function(t){n(t)})},this.show=function(t){o("GET",u,null,t)},this.contributors=function(t,e){e=e||1e3;var n=this;o("GET",u+"/stats/contributors",null,function(i,o,s){return i?t(i):void(202===s.status?setTimeout(function(){n.contributors(t,e)},e):t(i,o))})},this.contents=function(t,e,n){e=encodeURI(e),o("GET",u+"/contents"+(e?"/"+e:""),{ref:t},n)},this.fork=function(t){o("POST",u+"/forks",null,t)},this.branch=function(t,e,n){2===arguments.length&&"function"==typeof arguments[1]&&(n=e,e=t,t="master"),this.getRef("heads/"+t,function(t,i){return t&&n?n(t):void a.createRef({ref:"refs/heads/"+e,sha:i},n)})},this.createPullRequest=function(t,e){o("POST",u+"/pulls",t,e)},this.listHooks=function(t){o("GET",u+"/hooks",null,t)},this.getHook=function(t,e){o("GET",u+"/hooks/"+t,null,e)},this.createHook=function(t,e){o("POST",u+"/hooks",t,e)},this.editHook=function(t,e,n){o("PATCH",u+"/hooks/"+t,e,n)},this.deleteHook=function(t,e){o("DELETE",u+"/hooks/"+t,null,e)},this.read=function(t,e,n){o("GET",u+"/contents/"+encodeURI(e)+(t?"?ref="+t:""),null,function(t,e){return t&&404===t.error?n("not found",null,null):t?n(t):void n(null,e)},!0)},this.remove=function(t,e,n){a.getSha(t,e,function(i,s){return i?n(i):void o("DELETE",u+"/contents/"+e,{message:e+" is removed",sha:s,branch:t},n)})},this["delete"]=function(t,e,n){a.getSha(t,e,function(i,s){if(!s)return n("not found",null);var r=u+"/contents/"+e,a={message:"Deleted "+e,sha:s};r+="?message="+encodeURIComponent(a.message),r+="&sha="+encodeURIComponent(a.sha),r+="&branch="+encodeURIComponent(t),o("DELETE",r,null,n)})},this.move=function(t,e,n,o){i(t,function(i,s){a.getTree(s+"?recursive=true",function(i,r){r.forEach(function(t){t.path===e&&(t.path=n),"tree"===t.type&&delete t.sha}),a.postTree(r,function(n,i){a.commit(s,i,"Deleted "+e,function(e,n){a.updateHead(t,n,function(t){o(t)})})})})})},this.write=function(t,n,i,s,r){a.getSha(t,encodeURI(n),function(a,l){return a&&404!==a.error?r(a):void o("PUT",u+"/contents/"+encodeURI(n),{message:s,content:e(i),branch:t,sha:l},r)})},this.getCommits=function(t,e){t=t||{};var n=u+"/commits",i=[];if(t.sha&&i.push("sha="+encodeURIComponent(t.sha)),t.path&&i.push("path="+encodeURIComponent(t.path)),t.since){var s=t.since;s.constructor===Date&&(s=s.toISOString()),i.push("since="+encodeURIComponent(s))}if(t.until){var r=t.until;r.constructor===Date&&(r=r.toISOString()),i.push("until="+encodeURIComponent(r))}t.page&&i.push("page="+t.page),t.perpage&&i.push("per_page="+t.perpage),i.length>0&&(n+="?"+i.join("&")),o("GET",n,null,e)}},n.Gist=function(t){var e=t.id,n="/gists/"+e;this.read=function(t){o("GET",n,null,function(e,n){t(e,n)})},this.create=function(t,e){o("POST","/gists",t,e)},this["delete"]=function(t){o("DELETE",n,null,function(e,n){t(e,n)})},this.fork=function(t){o("POST",n+"/fork",null,function(e,n){t(e,n)})},this.update=function(t,e){o("PATCH",n,t,function(t,n){e(t,n)})},this.star=function(t){o("PUT",n+"/star",null,function(e,n){t(e,n)})},this.unstar=function(t){o("DELETE",n+"/star",null,function(e,n){t(e,n)})},this.isStarred=function(t){o("GET",n+"/star",null,function(e,n){t(e,n)})}},n.Issue=function(t){var e="/repos/"+t.user+"/"+t.repo+"/issues";this.list=function(t,n){var i=[];for(var o in t)t.hasOwnProperty(o)&&i.push(encodeURIComponent(o)+"="+encodeURIComponent(t[o]));s(e+"?"+i.join("&"),n)}},this.getIssues=function(t,e){return new n.Issue({user:t,repo:e})},this.getRepo=function(t,e){return new n.Repository({user:t,name:e})},this.getUser=function(){return new n.User},this.getGist=function(t){return new n.Gist({id:t})}};"undefined"!=typeof exports?module.exports=n:window.Github=n}).call(this),function(t){"use strict";var e=function(t){var e=this;this.github=null;var n=localStorage.getItem("github");if(console.log("token",n),n)console.log("token already exists!"),this.github=new Github({token:n,auth:"oauth"}),$.getJSON("https://api.github.com/user?access_token=828499f8ec9679f2acf0d16fe833a66abb9f605e",function(t){$("#login").html("Hello, "+t.login).attr("href","#")});else{var i=this.getQueryString();if(i.code){console.log("code:",i.code);var o=i.code;$.getJSON("https://whispering-stream-9425.herokuapp.com/authenticate/"+o,function(t){console.log("Token CREATED: ",t),localStorage.setItem("github",t.token),$.getJSON("https://api.github.com/user?access_token=828499f8ec9679f2acf0d16fe833a66abb9f605e",function(t){$("#login").html("Hello, "+t.login).attr("href","#")}),e.github=new Github({token:t.token,auth:"oauth"})})}}this.map=null,this.layers=[],this.extent=[[-115.85,-38.82],[119.25,52.58]],this.snippet="This is a new map",this.title="New Map",this.webmap={},this.defaultWebMap={},this.defaultWebMap.item={title:this.title,snippet:this.snippit,extent:this.extent},this.defaultWebMap.itemData={baseMap:{baseMapLayers:[{opacity:1,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer"},{opacity:.3,visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}],title:"basemap"},version:"1.0"},this.getWebMap(function(){e._setDefaultRenderers(),e._initMap(),e._wire()});new OpenSearch("search-container",{})};e.prototype.getWebMap=function(t){var e,n,i=this;if(this.github){var o=this.getQueryString();this.gistId=o.gistId||null,this.mapId=o.mapId||this.guid,this.gistId&&this.mapId?(n=this.github.getGist(this.gistId),n.read(function(n,o){_.each(o.files,function(t){t.filename===i.mapId&&(e=JSON.parse(t.content))}),e?(i.webmap=e,i._layersFromWebMapJson(),$("#save-text").html("Save Gist")):i.webmap=i.defaultWebMap,t()})):(i.webmap=i.defaultWebMap,t())}else i.webmap=i.defaultWebMap,t()},e.prototype._initMap=function(){var t=this;require(["esri/map","esri/urlUtils","esri/arcgis/utils","esri/layers/FeatureLayer","esri/renderers/SimpleRenderer","esri/renderers/jsonUtils","dojo/domReady!"],function(e,n,i,o,s,r){t.FeatureLayer=o,t.SimpleRenderer=s,t.jsonUtils=r,i.createMap(t.webmap,"map",{mapOptions:{minZoom:2}}).then(function(e){t.map=e.map,t.map.on("extent-change",function(){t._updateExtent()})})})},e.prototype.addLayerToMap=function(e,n){var i,o=this;this.malette&&this.malette.destroy();var s=new this.FeatureLayer(e,{mode:this.FeatureLayer.MODE_ONDEMAND,outFields:["*"]});this.map.addLayer(s),this.layers.push({url:e,visibility:!0,opacity:.78,mode:1,title:s.name,id:s.id,layerDefinition:{drawingInfo:{renderer:{}}}}),s.on("load",function(){switch(s.minScale=0,s.maxScale=0,console.log("layer loaded!",s),s.geometryType){case"esriGeometryPoint":i="point";break;case"esriGeometryPolygon":i="polygon";break;default:i="point"}var r=o.isWebMercator(s.spatialReference);r?o.map.setExtent(s.fullExtent.expand(2),!1):o.projectGeometries(s.fullExtent.spatialReference.wkid,102100,"esriGeometryEnvelope",s.fullExtent).done(function(t){var e=t.geometries[0];e.spatialReference={wkid:102100};var n=new esri.geometry.Extent(e);o.map.setExtent(n.expand(2),!1)});var a=o.renderers[i],u=new o.SimpleRenderer(a);s.setRenderer(u),s.redraw(),o._updateLayers(e,u),$.getJSON("http://opendata.arcgis.com/datasets/"+n+".json",function(n){var r=n.data.fields,u=n.data.name;o.malette=new Malette("map",{title:u,style:a,formatIn:"esri-json",formatOut:"esri-json",fields:r,type:i,exportStyle:!0}),t.malette=o.malette,"polygon"===i?setTimeout(function(){$("#malette-theme-color-option").trigger("click")},100):"point"===i&&setTimeout(function(){$("#malette-size-tab").trigger("click"),$("#malette-graduated-size-option").trigger("click")},100),o.malette.on("style-change",function(t){console.log("exported style",t);var n=o.jsonUtils.fromJson(t);s.setRenderer(n),s.redraw(),o._updateLayers(e,n)})})})},e.prototype._layersFromWebMapJson=function(){var t=this;this.webmap.itemData.operationalLayers.forEach(function(e){var n={};n.url=e.url,n.visibility=e.visibility,n.opacity=e.opacity,n.layerDefinition=e.layerDefinition,n.mode=e.mode,n.id=e.id,t.layers.push(n)})},e.prototype._updateLayers=function(t,e){this.layers.forEach(function(n){n.url===t&&(n.layerDefinition.drawingInfo.renderer=e.toJson())})},e.prototype._updateExtent=function(){var t=this.map.geographicExtent;this.extent=[[t.xmin,t.ymin],[t.xmax,t.ymax]]},e.prototype.getBasemapLayers=function(){var t=[];return this.webmap.itemData.baseMap.baseMapLayers.forEach(function(e){var n={};n.opacity=e.opacity,n.visibility=e.visibility,n.url=e.url,t.push(n)}),t},e.prototype._buildWebMapJson=function(){var t={},e=this.getBasemapLayers();return t.item={title:this.title,snippet:this.snippet,extent:this.extent},t.itemData={operationalLayers:this.layers,baseMap:{baseMapLayers:e,title:"basemap"},version:"1.0"},console.log("web map json: ",t),t},e.prototype.save=function(){var e=this,n=this._buildWebMapJson(),i=this.getQueryString();this.gistId=i.gistId||null,this.mapId=i.mapId||this.guid(),$("#save-text").html("Saving..."),console.log("saving...",n);var o={description:this.snippet,"public":!0,files:{}};if(o.files[this.mapId]={content:JSON.stringify(n)},this.gistId){var s=this.github.getGist(this.gistId);s.update(o,function(t,e){$("#save-text").html("Save Gist")})}else{var s=this.github.getGist();s.create(o,function(n,o){i.mapId=e.mapId,i.gistId=o.id,i=e.setQueryString(i),console.log("qs",i),t.history.pushState("","","?"+i),$("#save-text").html("Save Gist")})}},e.prototype.clearLayers=function(){var t=this;$("#style-map").addClass("disabled"),this.malette&&(this.malette.destroy(),this.malette=null),this.map.graphicsLayerIds.forEach(function(e){t.map.removeLayer(t.map.getLayer(e))}),this.layers=[],this.save()},e.prototype.guid=function(){return Math.random().toString(36).substr(2,9)},e.prototype.setQueryString=function(t){return $.param(t)},e.prototype.getQueryString=function(){var e,n,i=t.location.search.substring(1).split("&"),o={};for(n in i)""!==i[n]&&(e=i[n].split("="),o[decodeURIComponent(e[0])]=decodeURIComponent(e[1]));return o},e.prototype.isWebMercator=function(t){var e=[102100,102113,3857],n=!1;return e.forEach(function(e){(t.wkid===e||t.latestWkid===e)&&(n=!0)}),n},e.prototype.projectGeometries=function(t,e,n,i){var o="http://utilitydev.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer/project",s={geometryType:n,geometries:[i]},r={geometries:JSON.stringify(s),transformForward:!1,transformation:"",inSR:t,outSR:e,f:"json"},a={url:o,method:"POST",data:r,dataType:"json"};return $.ajax(a)},e.prototype._setDefaultRenderers=function(){this.renderers={point:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:1.3,type:"esriSLS",style:"esriSLSSolid"}}},polygon:{type:"simple",label:"",description:"",symbol:{color:[43,140,190,200],size:6,angle:0,xoffset:0,yoffset:0,style:"esriSFSSolid",type:"esriSFS",outline:{color:[255,255,255,255],width:.5,type:"esriSLS",style:"esriSLSSolid"}}}}},e.prototype._wire=function(){var t=this;console.log("wire me");var e=this.getQueryString();"true"===e.edit&&$(".tool").show(),$("#clear-layers").on("click",function(){t.clearLayers()}),$("#add-data").on("click",function(){$("#search-container").toggle()}),$("#save-map").on("click",function(){t.save()}),$("#map").on("dragover",function(t){t.preventDefault()}),this.layers.length&&$("#style-map").removeClass("disabled"),$("#style-map").on("click",function(){$(this).hasClass("disabled")||t.showMalette()}),$("#map").on("drop",function(e){var n=e.originalEvent.dataTransfer.getData("text"),i=n.split(","),o=i[0],s=i[1];$("#search-container").hide(),t.addLayerToMap(o,s)})},t.App=e}(window);